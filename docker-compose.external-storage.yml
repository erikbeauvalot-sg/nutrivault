version: '3.8'

# Docker Compose configuration with EXTERNAL STORAGE
# Use this configuration when you want to store data outside Docker volumes
# This is useful for:
# - Easy backups (just copy the external directory)
# - Direct access to database files
# - Network storage (NFS, SMB, etc.)
# - Easier configuration management

services:
  nutrivault:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nutrivault
    restart: unless-stopped
    ports:
      - "${PORT:-3001}:3001"
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3001
      - DB_DIALECT=${DB_DIALECT:-sqlite}
      - DB_STORAGE=/app/backend/data/nutrivault_prod.db
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - REFRESH_TOKEN_SECRET=${REFRESH_TOKEN_SECRET}
      - BCRYPT_ROUNDS=${BCRYPT_ROUNDS:-12}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
    volumes:
      # External storage directories (on host)
      # Default location: ./external/* (relative to project root)
      # You can change these to any path on your host system

      # Configuration files (read-only for security)
      - ${CONFIG_DIR:-./external/config}:/app/config:ro

      # Database storage (read-write)
      - ${DATA_DIR:-./external/data}:/app/backend/data

      # Uploaded documents (read-write)
      - ${UPLOADS_DIR:-./external/uploads}:/app/backend/uploads

      # Application logs (read-write)
      - ${LOGS_DIR:-./external/logs}:/app/backend/logs

      # Optional: Mount custom .env file
      # - ${ENV_FILE:-./external/.env}:/app/.env:ro
    networks:
      - nutrivault-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    user: "${UID:-1001}:${GID:-1001}"  # Run as specific user (prevents permission issues)

  # Optional: Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: nutrivault-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ${SSL_DIR:-./external/ssl}:/etc/nginx/ssl:ro
      - ${CERTBOT_DIR:-./external/certbot}:/var/www/certbot:ro
    depends_on:
      - nutrivault
    networks:
      - nutrivault-network
    profiles:
      - with-nginx

networks:
  nutrivault-network:
    driver: bridge

# Note: No volumes defined here - all storage is on the host filesystem
