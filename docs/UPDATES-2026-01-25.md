# Updates - 2026-01-25

## Changements Implémentés

### 1. ✅ SendReminderButton - Position et Taille

**Modifications:**
- Déplacé le bouton "Send Reminder" **avant** le bouton "Terminer & Facturer"
- Supprimé `size="sm"` pour que le bouton ait la **même taille** que les autres boutons
- Position finale : Send Reminder → Terminer & Facturer → Modifier

**Fichiers modifiés:**
- `frontend/src/pages/VisitDetailPage.jsx`
- `frontend/src/components/SendReminderButton.jsx`

---

### 2. ✅ Billing Templates par Diététicien

**Architecture:**
Le système de billing templates est maintenant **par diététicien** :
- Chaque diététicien voit **seulement ses propres templates**
- Les **admins voient tous les templates** de tous les diététiciens
- Chaque diététicien peut **créer, modifier et supprimer** ses propres templates
- Les admins peuvent **gérer tous les templates**

**Logique de Filtrage:**
```javascript
// ADMIN : voit tous les templates
// DIETITIAN : voit seulement ses propres templates (where created_by = user.id)
```

**Permissions Vérifiées:**
- `getAllTemplates()` - Filtrage automatique par rôle
- `getTemplateById()` - Vérification de permission (403 si non autorisé)
- `updateTemplate()` - Seul le créateur ou admin peut modifier
- `deleteTemplate()` - Seul le créateur ou admin peut supprimer
- `setAsDefault()` - Seul le créateur ou admin peut définir comme défaut
- `getDefaultTemplate()` - Retourne le template par défaut du diététicien

**Fichiers modifiés:**
- `backend/src/services/billingTemplate.service.js`
  - Ajout paramètre `user` dans toutes les fonctions
  - Filtrage automatique par `created_by` pour non-admin
  - Vérifications de permissions
- `backend/src/controllers/billingTemplateController.js`
  - Passage de `req.user` au lieu de `req.user.id`
  - Gestion des erreurs 403 (Forbidden)

**Codes de Statut HTTP:**
- `200` - Succès
- `201` - Créé
- `400` - Mauvaise requête
- `403` - **Permission refusée** (nouveau)
- `404` - Non trouvé
- `500` - Erreur serveur

---

### 3. ✅ Traductions Complètes (FR + EN)

**Nouvelles Sections Ajoutées:**

#### A. `appointmentReminders` (Rappels de Rendez-vous)
```json
{
  "sendReminder": "Envoyer un rappel / Send Reminder",
  "sending": "Envoi... / Sending...",
  "confirmSend": "Confirmation avec nom du patient",
  "successMessage": "Message de succès avec email",
  "errorMessage": "Message d'erreur",
  "tooltips": {
    "available": "Disponible",
    "notScheduled": "Non programmée",
    "inPast": "Passée",
    "noEmail": "Pas d'email",
    "optedOut": "Désactivé",
    "dataUnavailable": "Données indisponibles"
  },
  "remindersSent": "X rappel(s) envoyé(s)"
}
```

#### B. `billingTemplates` (Modèles de Facturation)
```json
{
  "title": "Modèles de Facturation / Billing Templates",
  "myTemplates": "Mes Modèles / My Templates",
  "allTemplates": "Tous les Modèles (Admin)",
  "createTemplate": "Créer un Modèle",
  "editTemplate": "Modifier le Modèle",
  "deleteTemplate": "Supprimer le Modèle",
  "cloneTemplate": "Dupliquer",
  "setAsDefault": "Définir par défaut",
  "noPermissionView": "Pas de permission de voir",
  "noPermissionEdit": "Pas de permission de modifier",
  "noPermissionDelete": "Pas de permission de supprimer",
  "ownTemplatesOnly": "Vous ne voyez que vos propres modèles",
  "adminSeesAll": "Admin voit tous les modèles",
  ... (40+ clés traduites)
}
```

**Fichiers modifiés:**
- `frontend/src/locales/fr.json` (+80 lignes)
- `frontend/src/locales/en.json` (+80 lignes)

**Intégration dans le Code:**
- `frontend/src/components/SendReminderButton.jsx`
  - Ajout `useTranslation()` hook
  - Remplacement de tous les textes en dur par `t('appointmentReminders.xxx')`
  - Messages de confirmation, succès, erreurs traduits
  - Tooltips traduits

---

## Résumé des Fichiers Modifiés

### Backend (2 fichiers)
1. `backend/src/services/billingTemplate.service.js`
2. `backend/src/controllers/billingTemplateController.js`

### Frontend (5 fichiers)
1. `frontend/src/pages/VisitDetailPage.jsx`
2. `frontend/src/components/SendReminderButton.jsx`
3. `frontend/src/locales/fr.json`
4. `frontend/src/locales/en.json`

**Total:** 7 fichiers modifiés

---

## Testing Checklist

### SendReminderButton
- [ ] Le bouton apparaît **avant** "Terminer & Facturer"
- [ ] Le bouton a la **même taille** que les autres
- [ ] Tous les textes sont **traduits** (FR/EN)
- [ ] Les tooltips sont traduits
- [ ] Les messages de confirmation/succès/erreur sont traduits

### Billing Templates
- [ ] **Diététicien** : voit seulement ses propres templates
- [ ] **Admin** : voit tous les templates
- [ ] **Diététicien** : peut créer/modifier/supprimer ses templates
- [ ] **Diététicien** : **ne peut pas** modifier les templates d'autres diététiciens
- [ ] **Admin** : peut gérer tous les templates
- [ ] **403 Forbidden** retourné si permission refusée
- [ ] `getDefaultTemplate()` retourne le bon template selon le rôle

### Traductions
- [ ] Changer la langue (FR ↔ EN) fonctionne
- [ ] Tous les nouveaux textes sont traduits
- [ ] Pas de clés manquantes dans les deux langues
- [ ] Les pluriels fonctionnent correctement

---

## Messages d'Erreur

### 403 - Permission Refusée
- "You do not have permission to view this template"
- "You do not have permission to update this template"
- "You do not have permission to delete this template"
- "You do not have permission to set this template as default"

### 404 - Non Trouvé
- "Template not found"

---

## Notes Importantes

1. **Pas de migration nécessaire** : Le champ `created_by` existe déjà dans `billing_templates`
2. **Pas de changement de schéma** : Aucune modification de base de données
3. **Rétrocompatibilité** : Les templates existants continuent de fonctionner
4. **Sécurité renforcée** : Permissions strictes par rôle

---

**Date:** 2026-01-25
**Implémenté par:** Claude Code
**Status:** ✅ COMPLETE
